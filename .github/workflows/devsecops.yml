name: DevSecOps CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  devsecops-pipeline:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # 1Ô∏è‚É£ Checkout repo
      # ---------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------
      # 2Ô∏è‚É£ Setup Python and install dependencies
      # ---------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r app/requirements.txt

      # ---------------------------
      # 3Ô∏è‚É£ Run basic build/test
      # ---------------------------
      - name: Basic syntax test
        run: python -m py_compile app/app.py

      # ---------------------------
      # 4Ô∏è‚É£ SAST - Semgrep
      # ---------------------------
      - name: Run Semgrep (SAST)
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          generateSarif: true
          sarifFile: semgrep-results.sarif

      # ---------------------------
      # 5Ô∏è‚É£ SCA - Trivy filesystem scan
      # ---------------------------
      - name: Trivy FS Scan (SCA)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          ignore-unfixed: true
          format: table
          exit-code: 0
          vuln-type: os,library
          output: trivy-fs-report.txt

      # ---------------------------
      # 6Ô∏è‚É£ Build Docker image
      # ---------------------------
      - name: Build Docker image
        run: docker build -t devsecops-app .

      # ---------------------------
      # 7Ô∏è‚É£ Image Scan - Trivy
      # ---------------------------
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: devsecops-app
          format: table
          exit-code: 0
          output: trivy-image-report.txt

      # ---------------------------
      # 8Ô∏è‚É£ DAST - OWASP ZAP baseline scan
      # ---------------------------
      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://127.0.0.1:5000"
          cmd_options: "-t 60"

      # ---------------------------
      # 9Ô∏è‚É£ Upload reports as artifacts
      # ---------------------------
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-fs-report.txt
            trivy-image-report.txt
            semgrep-results.sarif

      # ---------------------------
      # üîü Send notification to webhook.site
      # ---------------------------
      - name: Send webhook notification
        run: |
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d '{"pipeline":"DevSecOps CI/CD","status":"Completed","timestamp":"'"$(date)"'"}'

