name: DevSecOps CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  devsecops-pipeline:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # 1Ô∏è‚É£ Checkout code
      # ---------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------
      # 2Ô∏è‚É£ Set up Python
      # ---------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------
      # 3Ô∏è‚É£ Install dependencies
      # ---------------------------
      - name: Install dependencies
        id: deps
        run: pip install -r app/requirements.txt
        continue-on-error: true

      - name: Notify Dependency Install
        if: always()
        run: |
          STATUS=${{ steps.deps.outcome }}
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{\"stage\":\"Dependency Install\",\"status\":\"$STATUS\",\"link\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      # ---------------------------
      # 4Ô∏è‚É£ Basic syntax test
      # ---------------------------
      - name: Basic syntax test
        id: syntax
        run: python -m py_compile app/app.py
        continue-on-error: true

      - name: Notify Syntax Test
        if: always()
        run: |
          STATUS=${{ steps.syntax.outcome }}
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{\"stage\":\"Syntax Test\",\"status\":\"$STATUS\",\"link\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      # ---------------------------
      # 5Ô∏è‚É£ SAST - Semgrep
      # ---------------------------
      - name: Run Semgrep (SAST)
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
        continue-on-error: true

      - name: Notify SAST
        if: always()
        run: |
          STATUS=${{ steps.semgrep.outcome }}
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{\"stage\":\"SAST (Semgrep)\",\"status\":\"$STATUS\",\"link\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      # ---------------------------
      # 6Ô∏è‚É£ SCA - Trivy FS Scan
      # ---------------------------
      - name: Trivy FS Scan (SCA)
        id: trivyfs
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          ignore-unfixed: true
          format: table
          exit-code: 0
          vuln-type: os,library
          output: trivy-fs-report.txt
        continue-on-error: true

      - name: Notify SCA
        if: always()
        run: |
          STATUS=${{ steps.trivyfs.outcome }}
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{\"stage\":\"SCA (Trivy FS)\",\"status\":\"$STATUS\",\"link\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      # ---------------------------
      # 7Ô∏è‚É£ Build Docker image
      # ---------------------------
      - name: Build Docker image
        id: dockerbuild
        run: docker build -t devsecops-app .
        continue-on-error: true

      - name: Notify Docker Build
        if: always()
        run: |
          STATUS=${{ steps.dockerbuild.outcome }}
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{\"stage\":\"Docker Build\",\"status\":\"$STATUS\",\"link\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      # ---------------------------
      # 8Ô∏è‚É£ Image Scan - Trivy
      # ---------------------------
      - name: Trivy Image Scan
        id: trivyimg
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: devsecops-app
          format: table
          exit-code: 0
          output: trivy-image-report.txt
        continue-on-error: true

      - name: Notify Image Scan
        if: always()
        run: |
          STATUS=${{ steps.trivyimg.outcome }}
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{\"stage\":\"Image Scan (Trivy)\",\"status\":\"$STATUS\",\"link\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      # ---------------------------
      # 9Ô∏è‚É£ DAST - OWASP ZAP (fixed version)
      # ---------------------------
      - name: Start Flask app container
        id: start_app
        run: |
          docker run -d -p 5000:5000 --name devsecops-app devsecops-app
          sleep 10

      - name: Run OWASP ZAP baseline scan
        id: zap
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://127.0.0.1:5000"
          cmd_options: "-t 60"
        continue-on-error: true

      - name: Stop and remove Flask container
        if: always()
        run: |
          docker stop devsecops-app || true
          docker rm devsecops-app || true

      - name: Notify DAST
        if: always()
        run: |
          STATUS=${{ steps.zap.outcome }}
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{\"stage\":\"DAST (OWASP ZAP)\",\"status\":\"$STATUS\",\"link\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

      # ---------------------------
      # üîü Upload reports
      # ---------------------------
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-fs-report.txt
            trivy-image-report.txt
        continue-on-error: true

      # ---------------------------
      # 11Ô∏è‚É£ Final summary webhook
      # ---------------------------
      - name: Send Final Summary
        if: always()
        run: |
          curl -X POST https://webhook.site/39136fac-99af-4f27-a456-950072d717e3 \
            -H "Content-Type: application/json" \
            -d "{
              \"pipeline\": \"DevSecOps CI/CD\",
              \"status\": \"Completed\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"timestamp\": \"$(date)\"
            }"
